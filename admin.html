<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard - WKW Quality</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="styles.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body {
        padding: 15px;
        background: #f0f4f8;
        font-family: "Roboto", sans-serif;
      }
      .container {
        max-width: 1600px;
        margin: 0 auto;
      }

      /* Login */
      #loginScreen .card {
        background: white;
        padding: 50px 30px;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
        max-width: 400px;
        margin: 60px auto;
        text-align: center;
      }
      #loginScreen input {
        width: 100%;
        padding: 16px;
        margin: 12px 0;
        border-radius: 12px;
        border: 2px solid #e2e8f0;
        font-size: 16px;
      }
      #loginScreen button {
        width: 100%;
        padding: 18px;
        background: #1a4971;
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 18px;
        margin-top: 20px;
        cursor: pointer;
      }

      /* Dashboard */
      .dashboard-header {
        text-align: center;
        margin: 30px 0;
      }
      .dashboard-header h1 {
        color: #1a4971;
        font-size: 32px;
      }
      .actions {
        text-align: center;
        margin: 20px 0;
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        justify-content: center;
      }
      .btn {
        padding: 14px 32px;
        border: none;
        border-radius: 50px;
        font-weight: bold;
        cursor: pointer;
        min-width: 180px;
      }
      .btn-export {
        background: #27ae60;
        color: white;
      }
      .btn-logout {
        background: #e74c3c;
        color: white;
      }

      /* Filters */
      .filters {
        background: white;
        padding: 20px;
        border-radius: 16px;
        margin: 20px 0;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
      }
      .filters select,
      .filters input {
        padding: 12px;
        border-radius: 10px;
        border: 2px solid #e2e8f0;
        font-size: 15px;
      }
      .filters button {
        padding: 12px 20px;
        background: #1a4971;
        color: white;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        font-weight: bold;
      }
      .filters .reset-btn {
        background: #e74c3c;
      }

      .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 25px;
        margin: 40px 0;
      }
      .chart-card {
        background: white;
        padding: 20px;
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        text-align: center;
      }

      .table-container {
        overflow-x: auto;
        margin: 30px 0;
        border-radius: 16px;
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.1);
      }
      table {
        width: 100%;
        min-width: 1200px;
        border-collapse: separate;
        border-spacing: 0;
        background: white;
        border-radius: 16px;
      }
      th {
        background: #1a4971;
        color: white;
        padding: 16px;
        text-align: center;
      }
      td {
        padding: 12px;
        text-align: center;
        border-bottom: 1px solid #eee;
      }
      tr:hover {
        background: #f0f7ff;
      }
      .score {
        font-weight: bold;
      }
      .score.high {
        color: #27ae60;
      }
      .score.medium {
        color: #f39c12;
      }
      .score.low {
        color: #e74c3c;
      }

      @media (max-width: 768px) {
        .dashboard-header h1 {
          font-size: 26px;
        }
        .actions {
          flex-direction: column;
          align-items: center;
        }
        .btn {
          width: 90%;
        }
        .filters {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <!-- Login -->
    <div id="loginScreen">
      <div class="card">
        <h2 style="color: #1a4971">Connexion Admin</h2>
        <input
          type="email"
          id="email"
          value="admin@wkw-group.com"
          placeholder="Email"
        />
        <input type="password" id="password" placeholder="Mot de passe" />
        <button id="loginBtn">Se connecter</button>
        <p id="error" style="color: #e74c3c; margin-top: 15px; display: none">
          Identifiants incorrects
        </p>
      </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" style="display: none">
      <div class="dashboard-header">
        <h1>Résultats Visites Qualité</h1>
        <p><strong id="totalCount">0</strong> réponse(s)</p>
      </div>

      <!-- Filtres -->
      <div class="filters">
        <select id="filterSite">
          <option value="">Tous les sites</option>
          <option value="WKWUT">WKWUT</option>
          <option value="WKWFR">WKWFR</option>
        </select>
        <input
          type="text"
          id="filterVisitor"
          placeholder="Filtrer par visiteur..."
        />
        <input type="date" id="filterDate" />
        <button onclick="applyFilters()">Appliquer</button>
        <button class="reset-btn" onclick="resetFilters()">
          Réinitialiser
        </button>
      </div>

      <div class="actions">
        <button class="btn btn-export" onclick="exportToExcel()">
          Exporter en Excel
        </button>
        <button class="btn btn-logout" onclick="logout()">Déconnexion</button>
      </div>

      <div class="charts-grid">
        <div class="chart-card">
          <h3>Q1 – Accueil</h3>
          <canvas id="chartQ1"></canvas>
        </div>
        <div class="chart-card">
          <h3>Q2 – Attentes</h3>
          <canvas id="chartQ2"></canvas>
        </div>
        <div class="chart-card">
          <h3>Q3 – Maîtrise QS</h3>
          <canvas id="chartQ3"></canvas>
        </div>
        <div class="chart-card">
          <h3>Q4 – KPIs</h3>
          <canvas id="chartQ4"></canvas>
        </div>
        <div class="chart-card">
          <h3>Q5 – Lean/5S</h3>
          <canvas id="chartQ5"></canvas>
        </div>
        <div class="chart-card">
          <h3>Q6 – Lignes</h3>
          <canvas id="chartQ6"></canvas>
        </div>
        <div class="chart-card">
          <h3>Q7 – Discipline</h3>
          <canvas id="chartQ7"></canvas>
        </div>
      </div>

      <div class="table-container">
        <div id="tableContainer">Chargement...</div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
      const SUPABASE_URL = "https://xodkwwxfpbgatkezbsiq.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhvZGt3d3hmcGJnYXRrZXpic2lxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzMDYzMzgsImV4cCI6MjA3OTg4MjMzOH0.AdujtGpcHwcV-COPQbrkf-1g7eG6NrwAtOciaCPTJj0";
      const supabase = window.supabase.createClient(
        SUPABASE_URL,
        SUPABASE_ANON_KEY
      );

      let allResponses = [];
      let filteredResponses = [];

      const categories = {
        positive: [
          "Très satisfaisant",
          "Oui totalement",
          "Excellent",
          "Très clair",
          "Très mature",
          "Très bon",
        ],
        good: ["Satisfaisant", "Partiellement", "Bon", "Clair", "Bonne"],
        medium: ["Moyen", "Peu clair", "Moyenne", "Moyen"],
        negative: [
          "À améliorer",
          "Insatisfaisant",
          "Pas clair",
          "Faible",
          "À renforcer",
          "Pas du tout",
        ],
      };

      document.getElementById("loginBtn").addEventListener("click", login);

      async function login() {
        const { error } = await supabase.auth.signInWithPassword({
          email: document.getElementById("email").value,
          password: document.getElementById("password").value,
        });
        if (error) {
          document.getElementById("error").style.display = "block";
        } else {
          document.getElementById("loginScreen").style.display = "none";
          document.getElementById("dashboard").style.display = "block";
          loadAllData();
        }
      }

      async function loadAllData() {
        const { data } = await supabase
          .from("survey_responses")
          .select("*")
          .order("created_at", { ascending: false });
        allResponses = data || [];
        filteredResponses = allResponses;
        updateView();
      }

      function applyFilters() {
        const site = document.getElementById("filterSite").value;
        const visitor = document
          .getElementById("filterVisitor")
          .value.toLowerCase();
        const date = document.getElementById("filterDate").value;

        filteredResponses = allResponses.filter((r) => {
          if (site && r.site !== site) return false;
          if (visitor && !r.visitor?.toLowerCase().includes(visitor))
            return false;
          if (date && r.visit_date !== date) return false;
          return true;
        });

        updateView();
      }

      function resetFilters() {
        document.getElementById("filterSite").value = "";
        document.getElementById("filterVisitor").value = "";
        document.getElementById("filterDate").value = "";
        filteredResponses = allResponses;
        updateView();
      }

      function updateView() {
        document.getElementById("totalCount").textContent =
          filteredResponses.length;
        updateCharts();
        updateTable();
      }

      function countResponses(q) {
        const counts = {
          positive: 0,
          good: 0,
          medium: 0,
          negative: 0,
          total: filteredResponses.length,
        };
        filteredResponses.forEach((r) => {
          const ans = r[q];
          if (!ans) return;
          if (categories.positive.some((v) => ans.includes(v)))
            counts.positive++;
          else if (categories.good.some((v) => ans.includes(v))) counts.good++;
          else if (categories.medium.some((v) => ans.includes(v)))
            counts.medium++;
          else counts.negative++;
        });
        return counts;
      }

      function updateCharts() {
        const qs = ["q1", "q2", "q3", "q4", "q5", "q6", "q7"];
        const colors = ["#27ae60", "#3498db", "#f39c12", "#e74c3c"];
        const labels = ["Très bon", "Bon", "Moyen", "À améliorer"];

        qs.forEach((q) => {
          const c = countResponses(q);
          const data = [c.positive, c.good, c.medium, c.negative];
          const chart = Chart.getChart(`chart${q.toUpperCase()}`);
          if (chart) chart.destroy();
          new Chart(document.getElementById(`chart${q.toUpperCase()}`), {
            type: "doughnut",
            data: {
              labels,
              datasets: [
                {
                  data,
                  backgroundColor: colors,
                  borderWidth: 3,
                  borderColor: "#fff",
                },
              ],
            },
            options: {
              responsive: true,
              plugins: { legend: { position: "bottom" } },
            },
          });
        });
      }

      function calculateScore(r) {
        const map = {
          "Très satisfaisant": 4,
          Satisfaisant: 3,
          "À améliorer": 2,
          Insatisfaisant: 1,
          "Oui totalement": 4,
          Partiellement: 3,
          Peu: 2,
          "Pas du tout": 1,
          Excellent: 4,
          Bon: 3,
          Moyen: 2,
          "À améliorer": 2,
          "Très clair": 4,
          Clair: 3,
          "Peu clair": 2,
          "Pas clair": 1,
          "Très mature": 4,
          Bonne: 3,
          Moyenne: 2,
          Faible: 1,
          "Très bon": 4,
          Bon: 3,
          Moyen: 2,
          "À améliorer": 2,
          "À renforcer": 2,
        };
        let score = 0;
        ["q1", "q2", "q3", "q4", "q5", "q6", "q7"].forEach((q) => {
          score += map[r[q]] || 0;
        });
        return score;
      }

      function updateTable() {
        let html = `<table>
        <tr><th>Date</th><th>Site</th><th>Visiteur</th><th>Q1</th><th>Q2</th><th>Q3</th><th>Q4</th><th>Q5</th><th>Q6</th><th>Q7</th>
            <th>Score /28</th><th>Points forts</th><th>Améliorations</th><th>Priorités</th><th>Commentaires</th></tr>`;

        filteredResponses.forEach((r) => {
          const score = calculateScore(r);
          const scoreClass =
            score >= 22 ? "high" : score >= 15 ? "medium" : "low";
          const prio =
            [r.priority1, r.priority2, r.priority3]
              .filter(Boolean)
              .join(" → ") || "-";
          html += `<tr>
          <td><strong>${new Date(r.visit_date).toLocaleDateString(
            "fr-FR"
          )}</strong></td>
          <td>${r.site || "-"}</td>
          <td>${r.visitor || "-"}</td>
          <td>${r.q1 || "-"}</td><td>${r.q2 || "-"}</td><td>${
            r.q3 || "-"
          }</td><td>${r.q4 || "-"}</td>
          <td>${r.q5 || "-"}</td><td>${r.q6 || "-"}</td><td>${r.q7 || "-"}</td>
          <td class="score ${scoreClass}">${score}/28</td>
          <td>${(r.strengths || "").substring(0, 60)}...</td>
          <td>${(r.improvements || "").substring(0, 60)}...</td>
          <td>${prio}</td><td>${r.comments || "-"}</td>
        </tr>`;
        });
        document.getElementById("tableContainer").innerHTML = html + "</table>";
      }

      // EXPORT EXCEL PARFAIT (colonnes demandées)
      function exportToExcel() {
        let csv =
          "\uFEFFDate,Site,Visiteur,Q1,Q2,Q3,Q4,Q5,Q6,Q7,Points forts,Améliorations,Priorités,Commentaires\n";
        filteredResponses.forEach((r) => {
          const prio =
            [r.priority1, r.priority2, r.priority3]
              .filter(Boolean)
              .join(" | ") || "";
          csv +=
            [
              new Date(r.visit_date).toLocaleDateString("fr-FR"),
              r.site || "",
              r.visitor || "",
              r.q1 || "",
              r.q2 || "",
              r.q3 || "",
              r.q4 || "",
              r.q5 || "",
              r.q6 || "",
              r.q7 || "",
              (r.strengths || "").replace(/"/g, '""'),
              (r.improvements || "").replace(/"/g, '""'),
              prio,
              (r.comments || "").replace(/"/g, '""'),
            ]
              .map((v) => `"${v}"`)
              .join(",") + "\n";
        });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(
          new Blob([csv], { type: "text/csv;charset=utf-8;" })
        );
        link.download = `WKW_Qualite_${new Date()
          .toISOString()
          .slice(0, 10)}.csv`;
        link.click();
      }

      function logout() {
        supabase.auth.signOut().then(() => location.reload());
      }
    </script>
  </body>
</html>
